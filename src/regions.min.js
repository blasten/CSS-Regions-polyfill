/* Copyright 2012 - Emmanuel Garcia */
(function(w){function j(b){this._regions=[];this._parts=[];this._observeRegions=!0;this._splited=!1;this.requestNewRegion=function(){};this.requestRemoveRegion=function(){};if(window.WebKitMutationObserver||window.MutationObserver){var a=this;this._observer=new (window.WebKitMutationObserver||window.MutationObserver)(function(b){x.call(a,b)})}else this._observer=null;this.flowTo(b);if(1>this._regions)throw s("At least one region is required");return this}function x(b){if(this._observeRegions){for(var a=
!1,c=0;c<b.length;c++)if("characterData"==b[c].type){a=!0;break}a&&this.split()}}function t(){if(this._observeRegions){for(var b,a,c=!1,g=this,d=0;d<this._regions.length;d++)if(b=this._regions[d].offsetWidth,a=this._regions[d].offsetHeight,this._regions[d]._offsetWidth!=b||this._regions[d]._offsetHeight!=a)"_offsetWidth"in this._regions[d]&&(c=!0),this._regions[d]._offsetWidth=b,this._regions[d]._offsetHeight=a;c&&this.split();setTimeout(function(){t.call(g)},100)}}function l(b){var a=this._regions[b];
if(a){var c=this._regions[b+1];a.style.position="relative";var g=a.offsetHeight,d=parseInt,e;e="getComputedStyle"in window?window.getComputedStyle(a).getPropertyValue("padding-bottom"):a.style["padding-bottom"];g-=d(e,10);g=u(a,a,g,[],b);this._parts[b]=g;if(c)if(g){for(d=0;d<a.childNodes.length;d++)e=a.childNodes[d].cloneNode(!0),c.appendChild(e);for(var d=g.path.length,f=c,c=0;c<d;c++){for(e=0;e<g.path[c];e++)f.removeChild(f.childNodes[0]);var h=a.childNodes.length;for(e=g.path[c]+1;e<h;e++)a.removeChild(a.childNodes[g.path[c]+
1]);a=a.childNodes[g.path[c]];f=f.childNodes[0]}a.nodeType==n?a.nodeValue=a.nodeValue.substr(0,g.from):a.parentNode.removeChild(a);f.nodeType==n&&(f.nodeValue=f.nodeValue.substr(g.from));l.call(this,b+1)}else this.requestRemoveRegion(c);else g&&this.requestNewRegion()}}function u(b,a,c,g,d){for(var e,f,h,j=0;j<b.childNodes.length;j++)if(e=b.childNodes[j],e.nodeType==v){if(f=e.style.display,e.style.display="inline-block",h=o(e,a).top+e.offsetHeight,e.style.display=f,h>c){a:{f=["IMG","IFRAME","VIDEO",
"CANVAS","SVG"];for(h=0;h<f.length;h++)if(f[h]==e.tagName){f=!0;break a}f=!1}if(f)return{path:g.concat(j),from:-1};if(e=u(e,a,c,g.concat(j),d))return e}}else if(e.nodeType==n){var k;f=e.nodeValue.replace(/\s+/g," ");var m=f.length;h=document.createElement("span");var l=document.createTextNode(""),i={top:Infinity,start:0,end:0},p=0,q=m;b.insertBefore(h,e.nextSibling);for(b.insertBefore(l,h.nextSibling);p<q;){k=Math.floor((p+q)/2);i.start=f.indexOf(" ",k);i.end=f.indexOf(" ",i.start+1);if(-1==i.start||
-1==i.end)break;h.style.display=i.end-1>i.start?"inline":"inline-block";r(f,i,h);i.top=o(h,a).top+h.offsetHeight;if(i.top>c)q=k-1;else if(i.top<c)p=k+1;else break}if(-1==i.start||-1==i.end)e.nodeValue=e.nodeValue+" "+h.innerHTML+" "+h.nextSibling.nodeValue,b.removeChild(h),b.removeChild(l);else{if(i.top<=c){k=i.end;c=i.top;for(d={top:void 0,start:void 0,end:void 0};k<m;)if(d.start=k,d.end=f.indexOf(" ",i.start+1),-1==d.end&&(d.end=m),r(f,d,h),d.top=o(h,a).top+h.offsetHeight,d.top==c)i=d,k=i.end;else break;
d.top==c&&(i.start=i.end)}else{m=i.start;c=i.top;for(d={top:void 0,start:void 0,end:void 0};0<m;)if(d.end=m,d.start=f.lastIndexOf(" ",d.end-1),-1==d.start&&(d.start=0),r(f,d,h),d.top=o(h,a).top+h.offsetHeight,d.top==c)i=d,m=i.start;else break}e.nodeValue=e.nodeValue+" "+h.innerHTML+" "+h.nextSibling.nodeValue;b.removeChild(h);b.removeChild(l);return{path:g.concat(j),from:i.start+1}}}return null}function r(b,a,c){c.innerHTML=b.substr(a.start,a.end-a.start);c.previousSibling.nodeValue=b.substr(0,a.start);
c.nextSibling.nodeValue=b.substr(a.end)}function s(b,a){var c=function(b){this.name=a||"RegionError";this.message=b};c.prototype=Error();c.prototype.constructor=c;return new c(b)}function o(b,a){var c={top:0,left:0};do c.left+=b.offsetLeft,c.top+=b.offsetTop;while((b=b.offsetParent)&&b!=a);return c}var v=1,n=3;j.prototype.flowTo=function(b){if(b&&"object"==typeof b&&b instanceof window.Element&&b.nodeType==v){for(var a=0;a<this._regions.length;a++)if(this._regions[a]===b)return!1;b.isRegion=!0;this._regions.push(b);
this._parts.push(null);this._splited&&l.call(this,a-1)}else throw s(b+" is not an element");return this};j.prototype.removeRegion=function(b){if(null===b)return this;b.isRegion=!1;this._observer&&this._observer.disconnect();for(var a=0;a<this._regions.length;a++)if(this._regions[a]===b){this.rebuild();this._regions.splice(a,1);this._parts.splice(a,1);break}this.split();return this};j.prototype.split=function(){this._splited=!0;this.rebuild();this._observer&&this._observer.disconnect();l.call(this,
0);if(this._observer)for(var b=0;b<this._regions.length;b++)this._observer.observe(this._regions[b],{subtree:!0,attributes:!0,characterData:!0});t.call(this);return this};j.prototype.getRegionElement=function(b){for(;null!==b;){if(b.isRegion)for(var a=0;a<this._regions.length;a++)if(b==this._regions[a])return a;b=b.parentNode}return null};j.prototype.rebuild=function(){this._observer&&this._observer.disconnect();for(var b,a,c,g=this._regions.length-1;0<g;g--)if(b=this._parts[g-1]){b=this._regions[g];
a=this._regions[g-1];for(c=b;c.firstChild;)c=c.firstChild;for(;a.lastChild;)a=a.lastChild;for(var d=0,e=!0;c!=b;){for(var f=c.parentNode,h=a.parentNode;f.childNodes.length>d;)e?(a.nodeType==n&&c.nodeType==n&&(a.nodeValue+=c.nodeValue,f.removeChild(f.childNodes[0])),e=!1):h.appendChild(f.childNodes[d]);a=h;c=f;d=d||1}this._regions[g].firstChild&&this._regions[g].removeChild(this._regions[g].firstChild);this._parts[g]=null}this._parts[0]=null;return this};j.prototype.getRegions=function(){return this._regions};
Object.defineProperty(j,"nativeSupport",{value:function(){return!1},writable:!1,enumerable:!1,configurable:!1});w.Regions=j})(this);
